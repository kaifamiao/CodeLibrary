### å­¦ä¹ æ€è·¯

- ç±»ä¼¼ [LRU](https://leetcode-cn.com/problems/lru-cache/) çš„é¢˜
- è€ƒå¯Ÿç‚¹æ ¸å¿ƒï¼šè®¾è®¡æ•°æ®ç»“æ„ã€é“¾è¡¨æ“ä½œã€ç»†å¿ƒ(è‚‰çœ¼debug)
- å»ºè®®
  - å…ˆè¯•ç€å®Œå…¨è‡ªå·±è®¾è®¡æ•°æ®ç»“æ„ï¼Œç”»ç”»å›¾ï¼Œè‡³å°‘æœ‰ä¸ªè‡ªå·±çš„æ€è·¯
  - å®åœ¨æƒ³ä¸å‡ºæ¥ï¼Œæˆ–æƒ³å‡ºæ¥äº†ä½†æ€»æ˜¯ä¸é€šè¿‡
    - æˆ–å¿ƒæ€å´©æºƒè€å­ä¸å¹²äº†ä½†å¥½åƒè¿˜å¯ä»¥å†æŠ¢æ•‘ä¸€ä¸‹
    - å¯ä»¥å¼€å§‹çœ‹åˆ«äººçš„æ€è·¯äº†
  - ç¬”è€…çš„å­¦ä¹ æ–¹æ³•ï¼š**ä¸€ç‚¹ä¸€ç‚¹å­¦ï¼Œä¸€ç‚¹ä¸€ç‚¹è‡ªå·±å†™**
    - `Node` èŠ‚ç‚¹æ€ä¹ˆå®šä¹‰ï¼Œå¢åŠ  `int freq` é¢‘ç‡å±æ€§æ˜¯å¦æ›´å¥½
    - `DoubleLinkedList` åŒå‘é“¾è¡¨ä¸­å®šä¹‰äº†å“ªäº› `public` æ–¹æ³•ï¼Œæ˜¯å¦åŠ ä¸Šå“¨å…µèŠ‚ç‚¹(`head`, `tail`)æ›´å¥½å®ç°
    - `Cache` ä¸»ç±»æœ‰å“ªäº› `private` å±æ€§ï¼Œå°è£…äº†å“ªäº› `private` æ–¹æ³•
    - è‡³æ­¤ï¼Œå¯ä»¥è¯´å·²ç»æŠŠåˆ«äººçš„ **æ€è·¯å…³é”®ç‚¹** æ”¾åˆ°è‡ªå·±çš„è„‘è¢‹é‡Œäº†
      - æ¯•ç«Ÿæœ€å¸Œæœ›åœ¨é¢˜è§£ä¸­æ‰¾åˆ°çš„ï¼Œæ˜¯ã€Œæˆ‘åˆ°åº•å·®äº† **å“ªä¸€ç‚¹** å°±å…¨é€šäº†ã€
- å‚è€ƒ [Sweetiee ğŸ¬](https://leetcode-cn.com/problems/lfu-cache/solution/java-13ms-shuang-100-shuang-xiang-lian-biao-duo-ji/)
- å‚è€ƒ [liweiwei1419](https://leetcode-cn.com/problems/lfu-cache/solution/ha-xi-biao-shuang-xiang-lian-biao-java-by-liweiwei/)

### æ„å»ºèŠ‚ç‚¹

- é™¤äº† `freq` ï¼Œå…¶ä»–å±æ€§åº”è¯¥æ˜¯å¤§å¤šèƒ½æƒ³åˆ°çš„ï¼ˆå»ºè®®å…ˆåš LRU çš„é¢˜ï¼‰
- `freq` æ²¡æœ‰ä¼šæ€æ ·ï¼Œæ˜¯å¦æœ‰å…¶ä»–æ–¹å¼è§£å†³ï¼Œéƒ½ä¸å¦‚è‡ªå·±è¯•è¯•æ›´æ·±åˆ»

```java
public class LFUCacheNode {
    int key, value, freq; // freq é¢‘ç‡
    LFUCacheNode prev, next;
    public LFUCacheNode(int key, int value) {
        this.key = key;
        this.value = value;
        this.freq = 1;
        this.prev = this.next = null;
    }
}
```

### æ„å»ºåŒå‘é“¾è¡¨

- éœ€è¦æ”¯æŒçš„æ“ä½œæœ‰ï¼š
  - ä»å·²æœ‰é¢‘ç‡çš„é“¾è¡¨ä¸­åˆ é™¤ `remove(node)`
  - åŠ å…¥åˆ°æ–°é¢‘ç‡çš„é“¾è¡¨ä¸­ `addFirst(node)`
  - æŒ¤å‡º **æœ€ä½é¢‘ç‡** é“¾è¡¨ä¸­çš„æœ€åä¸€ä½ `removeLast()`
- å¢åŠ å“¨å…µèŠ‚ç‚¹
- æ˜¯å¦éœ€è¦ `size`ã€`capacity` ï¼Ÿå¯ä»¥å…ˆåŠ ä¸Šï¼Œä¸ç”¨å†åˆ å˜›~

```java
public class LFUCacheDbLinkedList {
    private LFUCacheNode head, tail; // å“¨å…µèŠ‚ç‚¹ï¼Œæœ‰åŠ©äºå¢åˆ æ“ä½œçš„å®ç°

    public LFUCacheDbLinkedList() {
        head = new LFUCacheNode(-1, -1);
        tail = new LFUCacheNode(-2, -2);
        head.next = tail;
        tail.prev = head;
    }

    // addFirst
    public void add(LFUCacheNode target) {
        // å…ˆå†™å¥½å¢åŠ åçš„æ ·å­
        // head -> (target) -> node

        // è€è€å®å®å…ˆæ‹¿å‡º node
        LFUCacheNode node = head.next; 
        target.prev = head;
        target.next = node;

        head.next = target;
        node.prev = target;
    }

    // è‹¥ä¸ç¡®å®šæ˜¯å¦è¿”å›å€¼ï¼Œå°±éƒ½å…ˆè¿”ç€ï¼Œä¸éœ€è¦çš„è¯å†æ”¹å› void å˜›~
    public LFUCacheNode removeLast() {
        return remove(tail.prev);
    }

    // åˆ é™¤æŒ‡å®šæŸä¸€ä¸ªèŠ‚ç‚¹
    public LFUCacheNode remove(LFUCacheNode target) {
        if (isEmpty()) return null;

        // å…ˆå†™å¥½åˆ é™¤å‰çš„æ ·å­
        // node1 - target - node2
        LFUCacheNode node1 = target.prev, node2 = target.next;

        node1.next = node2;
        node2.prev = node1;

        target.prev = target.next = null;
        return target;
    }

    // æ€ä¹ˆéœ€è¦æœ‰æ–¹æ³•ï¼Ÿä¸äº†è§£çš„ç»Ÿç»Ÿåˆ æ‰ï¼Œå†™ç€å†™ç€å°±æ‚Ÿå‡ºæ¥äº†
    public boolean isEmpty() {
        return head.next == tail;
    }
}
```

### å®Œå–„ä¸»ç±»

- è‚¯å®šéœ€è¦ä¸€ä¸ª `map` å­˜å‚¨æ•°æ®
- æ ¹æ®å¤§ä½¬ä»¬çš„æ€è·¯ï¼Œæ¯ä¸ªé¢‘ç‡éƒ½æœ‰ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæ•… `freqMap`
- `size` , `capacity` å…ˆå†™ç€å°±å½“å…¨å±€å˜é‡
- `minF` å½“å‰æœ€ä½é¢‘ç‡æ˜¯ä»€ä¹ˆä¸œä¸œï¼Ÿå³ä¸Šæ–‡ã€Œæ„å»ºåŒå‘é“¾è¡¨ã€æ­¥éª¤ä¸­æåˆ°çš„ã€ŒæŒ¤å‡º **æœ€ä½é¢‘ç‡** é“¾è¡¨ä¸­æœ€åä¸€ä½ã€ï¼Œä¸ºäº†å¿«é€Ÿå®šä½è€Œå­˜åœ¨

```java
public class LFUCache {
    private Map<Integer, LFUCacheNode> map;
    private Map<Integer, LFUCacheDbLinkedList> freqMap;
    private int size, capacity, minF; // minF å½“å‰æœ€ä½é¢‘ç‡

    public LFUCache(int capacity) {
        map = new HashMap<>();
        freqMap = new HashMap<>();
        freqMap.put(1, new LFUCacheDbLinkedList()); // é»˜è®¤å¼€ä¸€ä¸ªé¢‘ç‡ä¸º 1 çš„é“¾è¡¨
        this.capacity = capacity;
        size = 0;
        minF = 1; // å½“å‰æœ€ä½é¢‘ç‡ 1
    }

    public int get(int key) {
        int res = -1;
        if (map.containsKey(key)) {
            LFUCacheNode node = map.get(key);
            res = node.value;
            useOnce(node); // å°è£…æ›´æ–°èŠ‚ç‚¹é¢‘ç‡çš„æ‰€æœ‰æ“ä½œ
        }
        return res;
    }

    public void put(int key, int value) {
        if (map.containsKey(key)) {
            // exist
            LFUCacheNode node = map.get(key);
            node.value = value; // åˆ«å¿˜äº†æ›´æ–°å€¼
            useOnce(node); // å°è£…æ›´æ–°èŠ‚ç‚¹é¢‘ç‡çš„æ‰€æœ‰æ“ä½œ
            return;
        }

        // not exist
        // æ–°å»ºèŠ‚ç‚¹
        LFUCacheNode newOne = new LFUCacheNode(key, value);
        map.put(key, newOne);
        // åŠ å…¥é¢‘ç‡ 1 çš„é“¾è¡¨
        LFUCacheDbLinkedList list1 = freqMap.get(1);
        list1.add(newOne);
        if (size == capacity) {
            // æŒ¤å‡º å½“å‰æœ€ä½é¢‘ç‡ é‡Œçš„æœ€åä¸€ä¸ª
            LFUCacheDbLinkedList listMin = freqMap.get(minF);
            LFUCacheNode removed = listMin.removeLast();
            // ã€æ˜“æ¼ã€‘ç§»é™¤æ•°æ®æ˜ å°„
            map.remove(removed.key);
        } else size++;

        // ã€æ˜“æ¼ã€‘æ›´æ–°å½“å‰æœ€ä½é¢‘ç‡
        minF = 1;
    }

    // å°è£…æ›´æ–°èŠ‚ç‚¹é¢‘ç‡çš„æ‰€æœ‰æ“ä½œ
    private void useOnce(LFUCacheNode node) {
        // åŸæ¥é¢‘ç‡çš„é“¾è¡¨
        LFUCacheDbLinkedList oriList = freqMap.get(node.freq);
        oriList.remove(node);

        // æ–°çš„é¢‘ç‡
        int newF = node.freq + 1;
        // ã€æ˜“é”™ã€‘è‹¥æ—§é“¾è¡¨é‡Œå·²ç»æ¸…ç©ºï¼Œåˆ™æ›´æ–°å½“å‰æœ€ä½é¢‘ç‡
        if (minF == node.freq && oriList.isEmpty()) minF = newF;

        // æ–°é¢‘ç‡çš„é“¾è¡¨å¢åŠ èŠ‚ç‚¹
        if (!freqMap.containsKey(newF)) freqMap.put(newF, new LFUCacheDbLinkedList());
        LFUCacheDbLinkedList newList = freqMap.get(newF);
        newList.add(node);

        // æ›´æ–°èŠ‚ç‚¹é¢‘ç‡
        node.freq = newF;
    }
}
```